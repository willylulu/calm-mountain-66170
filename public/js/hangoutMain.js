function getPicture(e){var a={};a.OverlayUrl=e,a.x=0,a.y=0,a.w=60,a.h=60,a.img=document.createElement("img"),a.img.src=e,a.img.onload=function(){drawImageOnCanvas(a.img,a.x,a.y,a.w,a.h)},a.OverlayImage=gapi.hangout.av.effects.createImageResource(a.OverlayUrl),a.Overlay=a.OverlayImage.createOverlay({scale:{magnitude:.125,reference:gapi.hangout.av.effects.ScaleReference.WIDTH}}),a.Overlay.setPosition(a.x,a.y),a.Overlay.setVisible(!0),pictureArray.push(a)}function face(e){faceOverlayUrl=e==faceOverlayUrl?"null":e,"null"!=faceOverlayUrl?(void 0!=overlay&&overlay.setVisible(!1),faceOverlayImage=gapi.hangout.av.effects.createImageResource(faceOverlayUrl),overlay=faceOverlayImage.createFaceTrackingOverlay({trackingFeature:gapi.hangout.av.effects.FaceTrackingFeature.NOSE_ROOT,scaleWithFace:!0,rotateWithFace:!0,scale:1.5}),overlay.setVisible(!0)):overlay.setVisible(!1)}function background(e){backgroundTroggle=e==backgroundImageUrl?"null":e,"null"!=backgroundTroggle?(backgroundImageUrl=e,backgroundImage=gapi.hangout.av.effects.createImageResource(backgroundImageUrl),gapi.hangout.av.effects.requestBackgroundReplacementLock(function(e){return e?(backgroundReplacement=gapi.hangout.av.effects.getBackgroundReplacement(),backgroundReplacement.resetModel(),backgroundReplacement.setAlphaThresholdAutoUpdating(!0),backgroundReplacement.setImageResource(backgroundImage),void backgroundReplacement.setVisible(!0)):void alert("Fail to get the background replacement lock.")})):gapi.hangout.av.effects.releaseBackgroundReplacementLock()}function moveOnCanvas(e){var a=$("#screenCanvas")[0].getBoundingClientRect();if(isMouseDown)if(choosePic!=-1){var t=(e.pageX-a.left)/canvas.width-.5,n=(e.pageY-a.top)/canvas.height-.5;pictureArray[choosePic].Overlay.setPosition(-t,n),pictureArray[choosePic].x=t,pictureArray[choosePic].y=n,cleanImageOnCanvas(),drawImageOnCanvas(pictureArray[choosePic].img,pictureArray[choosePic].x,pictureArray[choosePic].y,pictureArray[choosePic].w,pictureArray[choosePic].h)}else{var i=e.clientX-a.left,c=e.clientY-a.top;panCtx.lineTo(i,c),panCtx.stroke(),cleanImageOnCanvas()}}function downOnCanvas(e){choosePic=-1,isMouseDown=!0;for(var a=$("#screenCanvas")[0].getBoundingClientRect(),t=(e.pageX-a.left)/canvas.width-.5,n=(e.pageY-a.top)/canvas.height-.5,i=0;i<pictureArray.length;i++){var c=pictureArray[i];if(c.x+.2>t&&t>c.x-.2&&c.y+.2>n&&n>c.y-.2){choosePic=i;break}}if(choosePic==-1){panCtx.beginPath(),panCtx.strokeStyle=$("#panColor").val(),panCtx.lineWidth=2;var s=e.clientX-a.left,r=e.clientY-a.top;panCtx.moveTo(s,r)}}function upOnCanvas(e){var a=$("#screenCanvas")[0].getBoundingClientRect(),t=(e.pageX-a.left)/canvas.width-.5,n=(e.pageY-a.top)/canvas.height-.5;choosePic!=-1&&t>.35&&n>.35&&(pictureArray[choosePic].Overlay.setVisible(!1),pictureArray[choosePic].Overlay.dispose(),pictureArray[choosePic].OverlayImage.dispose(),pictureArray.splice(choosePic,1),cleanImageOnCanvas()),isMouseDown=!1,choosePic=-1}function drawImageOnCanvas(e,a,t,n,i){ctx.drawImage(e,(a+.5)*canvas.width-n/2,(t+.5)*canvas.height-i/2,n,i)}function cleanImageOnCanvas(){if(void 0!=ctx){ctx.clearRect(0,0,canvas.width,canvas.height),ctx.putImageData(panCtx.getImageData(0,0,canvas.width,canvas.height),0,0),ctx.drawImage(trashCanImg,canvas.width-60,canvas.height-60,60,60);for(var e=0;e<pictureArray.length;e++){var a=pictureArray[e];drawImageOnCanvas(a.img,a.x,a.y,a.w,a.h)}}}function cleanPan(){void 0!=panCtx&&(panCtx.clearRect(0,0,canvas.width,canvas.height),cleanImageOnCanvas())}function drawPanCanvas(){void 0!=panOverlayImage&&(panOverlay.setVisible(!1),panOverlay.dispose(),panOverlayImage.dispose()),panOverlayImage=gapi.hangout.av.effects.createImageResource(panCanvas.toDataURL()),panOverlay=panOverlayImage.createOverlay({scale:{magnitude:1,reference:gapi.hangout.av.effects.ScaleReference.WIDTH}}),panOverlay.setPosition(0,0),panOverlay.setVisible(!0)}function canvasInit(){canvas=$("#screenCanvas")[0],ctx=canvas.getContext("2d"),panCanvas=document.createElement("canvas"),panCanvas.width=canvas.width,panCanvas.height=canvas.height,panCtx=panCanvas.getContext("2d"),trashCanImg=document.createElement("img"),trashCanImg.src=trashCanImage,trashCanImg.onload=function(){ctx.drawImage(trashCanImg,canvas.width-60,canvas.height-60,60,60)},setInterval(drawPanCanvas,500)}function fitCanvas(e,a){var t=e.getAspectRatio(),n=a.width(),i=a.height()*t;n>i&&(n=i),e.setWidth(n),$("#videoControlPanel").css("height",a.height()),$("#videoControlPanel").css("overflow","auto"),$("#screenCanvas")[0].width=.8*$("#videoControlPanel").width(),$("#screenCanvas")[0].height=$("#screenCanvas")[0].width/t,subtitleCanvas.width=n,subtitleCanvas.height=100,subtitleCtx.textAlign="center",subtitleCtx.fillStyle="red",subtitleCtx.font="50px Georgia",subtitleCtx.translate(subtitleCanvas.width,0),subtitleCtx.scale(-1,1),cleanImageOnCanvas()}function startSpeech(){"webkitSpeechRecognition"in window?0==toggle?(recognition=new webkitSpeechRecognition,recognition.continuous=!0,recognition.interimResults=!0,recognition.lang="cmn-Hant-TW",recognition.onstart=function(){$("#catchVoice").val("Start Detect")},recognition.onend=function(){$("#catchVoice").val("Stop Detect")},recognition.onresult=function(e){var a=e.resultIndex,t=e.results[a].length-1;$("#catchVoice").val(e.results[a][t].transcript),sendSpeech()},toggle=!0,recognition.start(),$("#speechToggle").text("Stop")):(toggle=!1,void 0!=recognition&&(recognition.stop(),$("#catchVoice").val(""),sendSpeech(),$("#speechToggle").text("Start"))):alert("Your browser doesn't support this function!")}function sendSpeech(){var e=$("#catchVoice").val();patchToScreen(e)}function patchToScreen(e){subtitleCtx.clearRect(0,0,subtitleCanvas.width,subtitleCanvas.height);var a=subtitleCanvas.width/2,t=subtitleCanvas.height/2;subtitleCtx.fillText(e,a,t),drawSubtitleCanvas()}function drawSubtitleCanvas(){void 0!=subtitleOverlayImage&&(subtitleOverlay.setVisible(!1),subtitleOverlay.dispose(),subtitleOverlayImage.dispose()),subtitleOverlayImage=gapi.hangout.av.effects.createImageResource(subtitleCanvas.toDataURL()),subtitleOverlay=subtitleOverlayImage.createOverlay({scale:{magnitude:1,reference:gapi.hangout.av.effects.ScaleReference.WIDTH}}),subtitleOverlay.setPosition(0,.4),subtitleOverlay.setVisible(!0)}function init(){userID=md5(gadgets.views.getParams().appData),socketEvent(),gapi.hangout.onApiReady.add(function(e){var a=gapi.hangout.layout.getVideoCanvas(),t=$("#videoCanvasBody");fitCanvas(a,t),a.setVisible(!0),$(window).resize(function(){fitCanvas(a,t)})}),gapi.hangout.onair.onYouTubeLiveIdReady.add(function(e){youtubeLiveId=e.youTubeLiveId,socket.emit("sentYouInfo",{id:youtubeLiveId,hostID_FB:gadgets.views.getParams().appData,status:"prepare"})}),gapi.hangout.onair.onBroadcastingChanged.add(function(e){e.isBroadcasting&&socket.emit("changeClientStatus",{status:"startStream"})})}function socketEvent(){socket=io.connect("https://calm-mountain-66170.herokuapp.com"),socket.on("firstShakeHand",function(e){}),socket.on("sentYouInfoCheck",function(e){}),socket.on("sendMessage",function(e){var a=document.createElement("div");"startStream"==e.status?cssType="alert-info":"prepare"==e.status?cssType="alert alert-warning":"Video"==e.status&&(cssType="alert-danger"),a.className="msg alert "+cssType,a.innerHTML=e.userName+" : "+e.message,$("#commit").append(a)})}var socket,youtubeLiveId,userID,images,ctx,canvas,panCanvas,panCtx,trashCanImage="http://www.tenforums.com/geek/gars/images/2/types/thumb_Recycle_Bin_Empty.png",trashCanImg,pictureArray=[],faceOverlayUrl="null",faceOverlayImage,overlay,backgroundImageUrl,backgroundImage,backgroundReplacement=null,backgroundTroggle="null",isMouseDown=!1,choosePic=-1,panOverlayImage,panOverlay,subtitleCanvas=document.createElement("canvas"),subtitleCtx=subtitleCanvas.getContext("2d"),recognition,toggle=!1,subtitleOverlayImage,subtitleOverlay;gadgets.util.registerOnLoadHandler(init),window.fbAsyncInit=function(){FB.init({appId:"1730976823823523",xfbml:!0,version:"v2.7"})},function(e,a,t){var n,i=e.getElementsByTagName(a)[0];e.getElementById(t)||(n=e.createElement(a),n.id=t,n.src="//connect.facebook.net/en_US/sdk.js",i.parentNode.insertBefore(n,i))}(document,"script","facebook-jssdk");